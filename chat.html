<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Only Docs bot</title>

  <!-- Material Symbols (arrow icon) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=arrow_forward_ios">

  <style>
    :root{
      --bg: #000;
      --blue: #00aaff;       /* send icon + bot text */
      --yellow: #ffee00;     /* user text */
      --white: #ffffffc5;
      --gray-bubble: rgba(255,255,255,0.06);
      --maxWidth: 900px;
      --input-min-height: 44px;  /* initial textarea height */
      --input-max-height: 220px; /* how tall the textarea can auto-grow */
      --gutter: 22px;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family: sans-serif;
      color:var(--white);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow: hidden; /* only chat scrolls */
    }

    /* Title top-left */
    .brand {
      position: fixed;
      left: 18px;
      top: 12px;
      z-index: 40;
      display:flex;
      gap:8px;
      align-items:baseline;
      user-select: none;
      font-weight:700;
      font-size:18px;
    }
    .brand .only { color: var(--yellow); text-transform:none; }
    .brand .docs { color: var(--blue); text-transform:none; }
    .brand .bot  { color: var(--white); text-transform:none; }

    /* Centered stage for chat */
    .stage {
      max-width: var(--maxWidth);
      width: min(92%, var(--maxWidth));
      margin: 72px auto 0 auto;
      height: calc(100vh - 72px - var(--input-min-height) - 28px);
      display:flex;
      flex-direction:column;
    }

    /* Chat area (only this scrolls) */
    .chat {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 28px var(--gutter);
      display:flex;
      flex-direction:column;
      gap:16px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.12) transparent;
    }
    .chat::-webkit-scrollbar { width:10px; }
    .chat::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.10); border-radius:8px; }

    /* Message rows */
    .msg-row { display:flex; width:100%; }
    .msg-row.bot { justify-content:flex-start; }
    .msg-row.user { justify-content:flex-end; }

    /* Bubbles (neutral gray background, colored text) */
    .bubble {
      max-width:76%;
      padding: 14px 18px;
      border-radius: 14px;
      background: var(--gray-bubble);
      font-size: 16px;
      line-height:1.45;
      white-space: pre-wrap; /* preserve newlines / indentation */
      word-break: break-word;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      overflow-wrap: anywhere;
    }
    .bubble.bot { color: var(--blue); text-align:left; }
    .bubble.user { color: var(--yellow); text-align:left; }

    /* Input bar fixed at bottom */
    .input-bar {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      width: min(92%, var(--maxWidth));
      z-index: 60;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 14px;
      background: rgba(0,0,0,0.22);
      border: 2px solid rgba(255,255,255,0.08);
      display:flex;
      gap:12px;
      align-items:flex-end;
    }

    .input-left {
      flex:1;
      display:flex;
      align-items:flex-end;
      gap:12px;
    }

    /* Auto-resizing textarea */
    textarea.input-field {
      width:100%;
      min-height: var(--input-min-height);
      max-height: var(--input-max-height);
      resize: none;
      overflow: auto; /* will scroll internally after max height */
      padding: 10px 12px;
      border-radius: 10px;
      border: none;
      outline: none;
      background: rgba(255,255,255,0.03);
      color: #ddd;
      font-size: 15px;
      line-height: 1.4;
      font-family: sans-serif; 
      box-sizing: border-box;
    }
    textarea.input-field::placeholder { color: rgba(255,255,255,0.30); }

    /* Send button */
    .send-btn {
      width: 56px;
      height: 44px;
      display:inline-grid;
      place-items:center;
      border:none;
      background:transparent;
      cursor:pointer;
      padding:4px;
    }
    .send-btn[disabled] { opacity: 0.45; cursor: not-allowed; }

    /* material icon tweak */
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 20;
      font-size: 24px;
      line-height: 1;
      color: var(--blue);
    }

    /* small screens: slightly larger input area */
    @media (max-width:520px){
      :root{ --input-min-height: 48px; --input-max-height: 220px; }
      .brand { font-size:16px; }
      .bubble { font-size:15px; }
    }
  </style>
</head>
<body>

  <div class="brand" aria-hidden="true">
    <div class="only">Only</div>
    <div class="docs">Docs</div>
    <div class="bot">bot</div>
  </div>

  <div class="stage" role="main" aria-label="Chat area">
    <div id="chat" class="chat" role="log" aria-live="polite"></div>
  </div>

  <div class="input-bar" role="region" aria-label="Message input">
    <div class="input-left">
      <textarea id="msgInput" class="input-field" placeholder="Ask me..." spellcheck="false" rows="1" aria-label="Message input"></textarea>
    </div>

    <button id="sendBtn" class="send-btn" aria-label="Send" title="Send">
      <span class="material-symbols-outlined">arrow_forward_ios</span>
    </button>
  </div>

  <script>
    (function(){
      // Config
      const API_URL = "http://127.0.0.1:8000/ask";
      const TYPING_MIN_MS = 800;   // minimal typing delay
      const TYPING_MAX_MS = 1400;  // slight randomization

      // Elements
      const chat = document.getElementById('chat');
      const textarea = document.getElementById('msgInput');
      const sendBtn = document.getElementById('sendBtn');

      // Helpers
      function el(cls, text) {
        const row = document.createElement('div');
        row.className = 'msg-row ' + cls;
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + cls;
        bubble.textContent = text;
        row.appendChild(bubble);
        return { row, bubble };
      }

      function scrollToBottom(smooth = true){
        // keep chat scrolled to bottom
        chat.scrollTo({ top: chat.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
      }

      function setSendDisabled(v){
        sendBtn.disabled = v;
        textarea.disabled = v;
      }

      // Auto-resize textarea (A: grow until max, then scroll internally)
      function autoResizeTextarea() {
        textarea.style.height = 'auto';
        const scrollH = textarea.scrollHeight;
        const maxH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--input-max-height')) || 220;
        const finalH = Math.min(scrollH, maxH);
        textarea.style.height = finalH + 'px';
      }

      // Create message and return bubble element
      function addMessage(text, who) {
        const { row, bubble } = el(who, text);
        chat.appendChild(row);
        scrollToBottom(true);
        return { row, bubble };
      }

      // Send flow: show user msg, show typing..., call backend, replace typing with response
      async function sendMessage(){
        const raw = textarea.value;
        const query = raw.replace(/\u200B/g, '').trimEnd(); // remove zero-width if any, preserve leading indentation
        if(!query) return;

        // append user message immediately
        addMessage(raw, 'user');

        // clear and reset textarea
        textarea.value = '';
        autoResizeTextarea();
        textarea.focus();

        // append typing... placeholder as bot bubble
        const typingObj = addMessage('typing...', 'bot');
        setSendDisabled(true);

        // call backend
        let responseText = null;
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout guard

          const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if(!res.ok){
            throw new Error(`HTTP ${res.status}`);
          }

          // parse JSON (your backend returns {"response": "..."} )
          const data = await res.json();
          responseText = (data && (data.response || data.answer || data.result)) ?? 'No response';
        } catch (err) {
          console.error('Fetch error', err);
          responseText = 'Error: could not reach the server.';
        }

        // keep typing... visible for at least a small delay to mimic realistic pacing (not fake streaming)
        const delay = Math.max(TYPING_MIN_MS, Math.min(TYPING_MAX_MS, TYPING_MIN_MS + Math.random() * (TYPING_MAX_MS - TYPING_MIN_MS)));
        await new Promise(r => setTimeout(r, delay));

        // replace typing... with real response (preserve formatting/newlines)
        typingObj.bubble.textContent = responseText;
        scrollToBottom(true);
        setSendDisabled(false);
      }

      // Event listeners
      sendBtn.addEventListener('click', sendMessage);

      textarea.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          sendMessage();
        }
      });

      textarea.addEventListener('input', () => {
        autoResizeTextarea();
      });

      // initial focus
      window.addEventListener('load', () => {
        textarea.focus();
        autoResizeTextarea();
      });

      // If window resizes (mobile keyboard), keep bottom scrolled
      window.addEventListener('resize', () => {
        setTimeout(() => scrollToBottom(false), 120);
      });

    })();
  </script>
</body>
</html>
